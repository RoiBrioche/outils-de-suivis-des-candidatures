{% extends 'candidatures/base.html' %}

{% block title %}
    {% if object %}Modifier{% else %}Nouvelle{% endif %} candidature - Job Application Tracker
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-{% if object %}pencil{% else %}plus-circle{% endif %}"></i> 
                {% if object %}Modifier{% else %}Nouvelle{% endif %} candidature
            </h1>
            <a href="{% url 'candidatures:candidature-list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Retour à la liste
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Basic Information -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.periode_recherche.id_for_label }}" class="form-label">
                                {{ form.periode_recherche.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.periode_recherche }}
                            {% if form.periode_recherche.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.periode_recherche.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.statut.id_for_label }}" class="form-label">
                                {{ form.statut.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.statut }}
                            {% if form.statut.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.statut.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.entreprise.id_for_label }}" class="form-label">
                                {{ form.entreprise.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.entreprise }}
                            {% if form.entreprise.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.entreprise.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.poste.id_for_label }}" class="form-label">
                                {{ form.poste.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.poste }}
                            {% if form.poste.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.poste.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Optional Details -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.localisation.id_for_label }}" class="form-label">
                                {{ form.localisation.label }}
                            </label>
                            {{ form.localisation }}
                            {% if form.localisation.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.localisation.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.contrat.id_for_label }}" class="form-label">
                                {{ form.contrat.label }}
                            </label>
                            {{ form.contrat }}
                            {% if form.contrat.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.contrat.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.canal.id_for_label }}" class="form-label">
                                {{ form.canal.label }}
                            </label>
                            {{ form.canal }}
                            {% if form.canal.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.canal.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.date_candidature.id_for_label }}" class="form-label">
                                {{ form.date_candidature.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.date_candidature }}
                            {% if form.date_candidature.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.date_candidature.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Comments -->
                    <div class="mb-3">
                        <label for="{{ form.commentaires.id_for_label }}" class="form-label">
                            {{ form.commentaires.label }}
                        </label>
                        {{ form.commentaires }}
                        {% if form.commentaires.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.commentaires.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Status Information -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.date_statut.id_for_label }}" class="form-label">
                                {{ form.date_statut.label }}
                            </label>
                            {{ form.date_statut }}
                            {% if form.date_statut.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.date_statut.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.statut_contextuel.id_for_label }}" class="form-label">
                            {{ form.statut_contextuel.label }}
                        </label>
                        {{ form.statut_contextuel }}
                        {% if form.statut_contextuel.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.statut_contextuel.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Informations contextuelles du statut (format JSON)</div>
                    </div>

                    <!-- Priority Information -->
                    <hr>
                    <h5 class="mb-3">Priorité</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.priorite.id_for_label }}" class="form-label">
                                {{ form.priorite.label }}
                            </label>
                            {{ form.priorite }}
                            {% if form.priorite.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.priorite.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.priorite_source.id_for_label }}" class="form-label">
                                {{ form.priorite_source.label }}
                            </label>
                            {{ form.priorite_source }}
                            {% if form.priorite_source.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.priorite_source.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Documents Section -->
                    <hr>
                    <div class="mb-3">
                        <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDocumentForm" aria-expanded="false" aria-controls="collapseDocumentForm">
                            <i class="bi bi-paperclip"></i> Joindre un document (Optionnel)
                        </button>
                        
                        <div class="collapse" id="collapseDocumentForm">
                            <div class="card mt-3">
                                <div class="card-body">
                                    {{ document_formset.management_form }}
                                    
                                    {% if document_formset.non_form_errors %}
                                        <div class="alert alert-danger">
                                            {% for error in document_formset.non_form_errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}

                                    <div id="documents-container">
                                        {% for form in document_formset %}
                                            <div class="document-row border rounded p-3 mb-3">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="mb-0">
                                                        Document {{ forloop.counter }}
                                                        {% if form.instance.pk %}
                                                            <small class="text-muted">({{ form.instance.nom_fichier|default:form.instance.type_document }})</small>
                                                        {% endif %}
                                                    </h6>
                                                    {% if form.instance.pk or forloop.counter > 1 %}
                                                        <button type="button" class="btn btn-outline-danger btn-sm remove-document">
                                                            <i class="bi bi-trash"></i> Supprimer
                                                        </button>
                                                    {% endif %}
                                                </div>
                                                
                                                {% if form.non_field_errors %}
                                                    <div class="alert alert-danger">
                                                        {% for error in form.non_field_errors %}
                                                            {{ error }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}

                                                {% for hidden in form.hidden_fields %}
                                                    {% if hidden.name == 'DELETE' %}
                                                        <div style="display: none;">{{ hidden }}</div>
                                                    {% else %}
                                                        {{ hidden }}
                                                    {% endif %}
                                                {% endfor %}

                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="{{ form.type_document.id_for_label }}" class="form-label">
                                                                {{ form.type_document.label }}
                                                            </label>
                                                            {{ form.type_document }}
                                                            {% if form.type_document.errors %}
                                                                <div class="text-danger">
                                                                    {% for error in form.type_document.errors %}
                                                                        <small>{{ error }}</small>
                                                                    {% endfor %}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="{{ form.nom_fichier.id_for_label }}" class="form-label">
                                                                {{ form.nom_fichier.label }}
                                                            </label>
                                                            {{ form.nom_fichier }}
                                                            {% if form.nom_fichier.errors %}
                                                                <div class="text-danger">
                                                                    {% for error in form.nom_fichier.errors %}
                                                                        <small>{{ error }}</small>
                                                                    {% endfor %}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="{{ form.fichier.id_for_label }}" class="form-label">
                                                                {{ form.fichier.label }}
                                                            </label>
                                                            {{ form.fichier }}
                                                            {% if form.fichier.errors %}
                                                                <div class="text-danger">
                                                                    {% for error in form.fichier.errors %}
                                                                        <small>{{ error }}</small>
                                                                    {% endfor %}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="{{ form.commentaire.id_for_label }}" class="form-label">
                                                                {{ form.commentaire.label }}
                                                            </label>
                                                            {{ form.commentaire }}
                                                            {% if form.commentaire.errors %}
                                                                <div class="text-danger">
                                                                    {% for error in form.commentaire.errors %}
                                                                        <small>{{ error }}</small>
                                                                    {% endfor %}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>

                                    <div class="d-flex justify-content-between align-items-center">
                                        <button type="button" class="btn btn-outline-primary" id="add-document-btn">
                                            <i class="bi bi-plus-circle"></i> Ajouter un autre document
                                        </button>
                                        <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#collapseDocumentForm">
                                            <i class="bi bi-x-circle"></i> Fermer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'candidatures:candidature-list' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Annuler
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> 
                            {% if object %}Mettre à jour{% else %}Créer{% endif %} la candidature
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i> Aide
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small">
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success"></i> 
                        Les champs marqués d'un astérisque (*) sont obligatoires
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-info-circle text-info"></i> 
                        La date de candidature doit être dans la période de recherche sélectionnée
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-info-circle text-info"></i> 
                        Une seule période de recherche peut être active à la fois
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-lightbulb text-warning"></i> 
                        Si vous définissez une priorité, vous devez spécifier sa source
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-lightbulb text-warning"></i> 
                        Une priorité automatique aura sa date d'application définie automatiquement
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-file-earmark text-info"></i> 
                        Les documents sont optionnels lors de la création d'une candidature
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add form-control class to all form fields
    const formFields = document.querySelectorAll('input, select, textarea');
    formFields.forEach(field => {
        if (!field.classList.contains('form-control')) {
            field.classList.add('form-control');
        }
    });

    // Gestion de l'ajout dynamique de documents
    const addDocumentBtn = document.getElementById('add-document-btn');
    const documentsContainer = document.getElementById('documents-container');
    
    if (addDocumentBtn && documentsContainer) {
        addDocumentBtn.addEventListener('click', function() {
            // Cloner la première ligne de formulaire
            const firstRow = documentsContainer.querySelector('.document-row');
            if (!firstRow) return;
            
            const clone = firstRow.cloneNode(true);
            
            // Mettre à jour les index des formulaires
            const totalFormsInput = document.querySelector('input[name="documents-TOTAL_FORMS"]');
            const currentCount = parseInt(totalFormsInput.value);
            const newCount = currentCount + 1;
            
            // Mettre à jour tous les attributs name et id
            const allInputs = clone.querySelectorAll('input, select, textarea, label');
            allInputs.forEach(element => {
                // Mettre à jour les attributs for des labels
                if (element.tagName === 'LABEL' && element.htmlFor) {
                    element.htmlFor = element.htmlFor.replace(`documents-${currentCount-1}`, `documents-${currentCount}`);
                }
                
                // Mettre à jour les attributs name et id des inputs
                if (element.name) {
                    element.name = element.name.replace(`documents-${currentCount-1}`, `documents-${currentCount}`);
                }
                if (element.id) {
                    element.id = element.id.replace(`documents-${currentCount-1}`, `documents-${currentCount}`);
                }
            });
            
            // Vider les valeurs des champs du clone
            const inputs = clone.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                if (input.type === 'file' || input.type === 'text' || input.tagName === 'TEXTAREA') {
                    input.value = '';
                } else if (input.type === 'checkbox') {
                    input.checked = false;
                } else if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                }
            });
            
            // Vider les messages d'erreur
            const errorDivs = clone.querySelectorAll('.text-danger, .alert-danger');
            errorDivs.forEach(div => div.remove());
            
            // Mettre à jour le numéro du document
            const documentTitle = clone.querySelector('h6');
            if (documentTitle) {
                documentTitle.textContent = `Document ${newCount + 1}`;
            }
            
            // Afficher le bouton supprimer sur le clone
            const removeBtn = clone.querySelector('.remove-document');
            if (removeBtn) {
                removeBtn.style.display = 'block';
            }
            
            // Ajouter le clone au conteneur
            documentsContainer.appendChild(clone);
            
            // Mettre à jour le compteur TOTAL_FORMS
            totalFormsInput.value = newCount;
            
            // Ajouter les classes form-control aux nouveaux champs
            const newFormFields = clone.querySelectorAll('input, select, textarea');
            newFormFields.forEach(field => {
                if (!field.classList.contains('form-control')) {
                    field.classList.add('form-control');
                }
            });
            
            // Ajouter l'événement de suppression au nouveau bouton
            addRemoveEvent(clone.querySelector('.remove-document'));
        });
    }
    
    // Gestion de la suppression de documents
    function addRemoveEvent(button) {
        if (button) {
            button.addEventListener('click', function() {
                const documentRow = this.closest('.document-row');
                if (documentRow) {
                    // Cocher la case DELETE cachée
                    const deleteInput = documentRow.querySelector('input[name$="-DELETE"]');
                    if (deleteInput) {
                        deleteInput.value = 'on';
                        // Marquer visuellement la ligne comme supprimée
                        documentRow.style.opacity = '0.5';
                        documentRow.style.textDecoration = 'line-through';
                        button.disabled = true;
                        button.textContent = 'Marqué pour suppression';
                    } else {
                        // Si pas de champ DELETE (nouveau document), retirer la ligne du DOM
                        documentRow.remove();
                        
                        // Mettre à jour les numéros des documents restants
                        const remainingRows = documentsContainer.querySelectorAll('.document-row');
                        remainingRows.forEach((row, index) => {
                            const title = row.querySelector('h6');
                            if (title) {
                                // Conserver le nom du fichier existant si présent
                                const existingText = title.textContent;
                                const baseText = existingText.split('(')[0].trim();
                                const existingInfo = existingText.includes('(') ? existingText.split('(')[1] : '';
                                title.innerHTML = `Document ${index + 1} ${existingInfo ? '(' + existingInfo : ''}`;
                            }
                            
                            // Gérer l'affichage du bouton supprimer
                            const removeBtn = row.querySelector('.remove-document');
                            const hasInstance = row.querySelector('input[name$="-id"]'); // Vérifier si c'est un document existant
                            if (removeBtn) {
                                removeBtn.style.display = (index === 0 && !hasInstance) ? 'none' : 'block';
                            }
                        });
                        
                        // Mettre à jour le compteur TOTAL_FORMS
                        const totalFormsInput = document.querySelector('input[name="documents-TOTAL_FORMS"]');
                        if (totalFormsInput) {
                            totalFormsInput.value = Math.max(1, remainingRows.length);
                        }
                    }
                }
            });
        }
    }
    
    // Initialiser les boutons de suppression existants
    const existingRemoveBtns = document.querySelectorAll('.remove-document');
    existingRemoveBtns.forEach(addRemoveEvent);
});
</script>
{% endblock %}
