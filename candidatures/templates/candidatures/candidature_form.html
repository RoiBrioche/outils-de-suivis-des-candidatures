{% extends 'candidatures/base.html' %}

{% block title %}
    {% if object %}Modifier{% else %}Nouvelle{% endif %} candidature - Job Application Tracker
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-{% if object %}pencil{% else %}plus-circle{% endif %}"></i> 
                {% if object %}Modifier{% else %}Nouvelle{% endif %} candidature
            </h1>
            <a href="{% url 'candidatures:candidature-list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Retour à la liste
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Basic Information -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.periode_recherche.id_for_label }}" class="form-label">
                                {{ form.periode_recherche.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.periode_recherche }}
                            {% if form.periode_recherche.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.periode_recherche.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.statut.id_for_label }}" class="form-label">
                                {{ form.statut.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.statut }}
                            {% if form.statut.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.statut.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.entreprise.id_for_label }}" class="form-label">
                                {{ form.entreprise.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.entreprise }}
                            {% if form.entreprise.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.entreprise.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.poste.id_for_label }}" class="form-label">
                                {{ form.poste.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.poste }}
                            {% if form.poste.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.poste.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Optional Details -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.localisation.id_for_label }}" class="form-label">
                                {{ form.localisation.label }}
                            </label>
                            {{ form.localisation }}
                            {% if form.localisation.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.localisation.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.contrat.id_for_label }}" class="form-label">
                                {{ form.contrat.label }}
                            </label>
                            {{ form.contrat }}
                            {% if form.contrat.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.contrat.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.canal.id_for_label }}" class="form-label">
                                {{ form.canal.label }}
                            </label>
                            {{ form.canal }}
                            {% if form.canal.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.canal.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.date_candidature.id_for_label }}" class="form-label">
                                {{ form.date_candidature.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.date_candidature }}
                            {% if form.date_candidature.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.date_candidature.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Comments -->
                    <div class="mb-3">
                        <label for="{{ form.commentaires.id_for_label }}" class="form-label">
                            {{ form.commentaires.label }}
                        </label>
                        {{ form.commentaires }}
                        {% if form.commentaires.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.commentaires.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Status Information -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.date_statut.id_for_label }}" class="form-label">
                                {{ form.date_statut.label }}
                            </label>
                            {{ form.date_statut }}
                            {% if form.date_statut.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.date_statut.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.statut_contextuel.id_for_label }}" class="form-label">
                            {{ form.statut_contextuel.label }}
                        </label>
                        {{ form.statut_contextuel }}
                        {% if form.statut_contextuel.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.statut_contextuel.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Informations contextuelles du statut (format JSON)</div>
                    </div>

                    <!-- Priority Information -->
                    <hr>
                    <h5 class="mb-3">Priorité</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.priorite.id_for_label }}" class="form-label">
                                {{ form.priorite.label }}
                            </label>
                            {{ form.priorite }}
                            {% if form.priorite.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.priorite.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.priorite_source.id_for_label }}" class="form-label">
                                {{ form.priorite_source.label }}
                            </label>
                            {{ form.priorite_source }}
                            {% if form.priorite_source.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.priorite_source.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Documents Section -->
                    <hr>
                    <h5 class="mb-3">Documents</h5>
                    <div class="mb-3">
                        <div class="text-muted small mb-3">
                            Ajoutez des références à vos documents (CV, lettre de motivation, etc.).
                        </div>
                        
                        {{ document_formset.management_form }}
                        
                        <div id="documents-container">
                            {% for doc_form in document_formset %}
                                <div class="document-item border rounded p-3 mb-3">
                                    {{ doc_form.id }}
                                    {{ doc_form.DELETE }}

                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            {{ doc_form.type_document.label_tag }}
                                            {{ doc_form.type_document }}
                                        </div>
                                        <div class="col-md-8 mb-3">
                                            {{ doc_form.chemin_fichier.label_tag }}
                                            {{ doc_form.chemin_fichier }}
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        {{ doc_form.commentaire.label_tag }}
                                        {{ doc_form.commentaire }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addDocument()">
                            <i class="bi bi-plus-circle"></i> Ajouter un document
                        </button>
                        
                        <!-- Empty form template for dynamic addition -->
                        <template id="empty-document-form">
                            <div class="document-item border rounded p-3 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">Document</h6>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeDocument(this)">
                                        <i class="bi bi-trash"></i> Supprimer
                                    </button>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Type de document</label>
                                        <select class="form-control" name="{{ document_formset.empty_form.type_document.html_name }}">
                                            <option value="">-- Choisir --</option>
                                            <option value="CV">CV</option>
                                            <option value="LETTRE_MOTIVATION">Lettre de motivation</option>
                                            <option value="PORTFOLIO">Portfolio</option>
                                            <option value="TEST_TECHNIQUE">Test technique</option>
                                            <option value="AUTRE">Autre</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8 mb-3">
                                        <label class="form-label">Chemin du fichier</label>
                                        <input type="text" class="form-control" name="{{ document_formset.empty_form.chemin_fichier.html_name }}" placeholder="C:\Users\Nom\Documents\mon_cv.pdf">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Commentaire (optionnel)</label>
                                    <textarea class="form-control" name="{{ document_formset.empty_form.commentaire.html_name }}" rows="2" placeholder="Notes sur ce document..."></textarea>
                                </div>
                                <input type="hidden" name="{{ document_formset.empty_form.id.html_name }}" value="">
                                <input type="hidden" name="{{ document_formset.empty_form.DELETE.html_name }}" value="">
                            </div>
                        </template>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'candidatures:candidature-list' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Annuler
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> 
                            {% if object %}Mettre à jour{% else %}Créer{% endif %} la candidature
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i> Aide
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small">
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success"></i> 
                        Les champs marqués d'un astérisque (*) sont obligatoires
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-info-circle text-info"></i> 
                        La date de candidature doit être dans la période de recherche sélectionnée
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-info-circle text-info"></i> 
                        Une seule période de recherche peut être active à la fois
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-lightbulb text-warning"></i> 
                        Si vous définissez une priorité, vous devez spécifier sa source
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-lightbulb text-warning"></i> 
                        Une priorité automatique aura sa date d'application définie automatiquement
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-file-earmark text-info"></i> 
                        Les documents sont optionnels lors de la création d'une candidature
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add form-control class to all form fields
    const formFields = document.querySelectorAll('input, select, textarea');
    formFields.forEach(field => {
        if (!field.classList.contains('form-control')) {
            field.classList.add('form-control');
        }
    });
});

let documentCount = 0;

function addDocument() {
    const container = document.getElementById('documents-container');
    const template = document.getElementById('empty-document-form');
    const formsetPrefix = '{{ document_formset.prefix }}';
    
    // Clone the template
    const clone = template.content.cloneNode(true);
    
    // Update form names and IDs with current count
    const totalFormsInput = document.querySelector(`input[name="${formsetPrefix}-TOTAL_FORMS"]`);
    const currentCount = parseInt(totalFormsInput.value);
    
    // Replace __prefix__ with actual count
    const allInputs = clone.querySelectorAll('input, textarea');
    allInputs.forEach(input => {
        input.name = input.name.replace('__prefix__', currentCount);
        if (input.id) {
            input.id = input.id.replace('__prefix__', currentCount);
        }
    });
    
    // Add to container
    container.appendChild(clone);
    
    // Update total forms count
    totalFormsInput.value = currentCount + 1;
    
    documentCount++;
}

function removeDocument(button) {
    const documentItem = button.closest('.document-item');
    const formsetPrefix = '{{ document_formset.prefix }}';
    
    // Find the DELETE input for this form
    const deleteInput = documentItem.querySelector(`input[name$="-DELETE"]`);
    if (deleteInput) {
        deleteInput.value = 'on';
    }
    
    // Remove from DOM immediately
    documentItem.remove();
    
    // Update total forms count
    const totalFormsInput = document.querySelector(`input[name="${formsetPrefix}-TOTAL_FORMS"]`);
    totalFormsInput.value = Math.max(0, parseInt(totalFormsInput.value) - 1);
}
</script>
{% endblock %}
